apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: dev-cluster-01

resources:
  - ../../cluster-templates/aws-ha/base
  - cluster-config.yaml

# Patches to customize the cluster
patches:
  # Update namespace references
  - target:
      kind: Namespace
    patch: |-
      - op: replace
        path: /metadata/name
        value: dev-cluster-01

  # Update ClusterDeployment with specific values
  - target:
      kind: ClusterDeployment
    patch: |-
      - op: replace
        path: /metadata/name
        value: dev-cluster-01
      - op: replace
        path: /metadata/namespace
        value: dev-cluster-01
      - op: replace
        path: /spec/clusterName
        value: dev-cluster-01
      - op: replace
        path: /spec/baseDomain
        value: dev.example.com
      - op: replace
        path: /spec/platform/aws/region
        value: us-east-1
      - op: replace
        path: /spec/provisioning/imageSetRef/name
        value: img4.20.10-x86-64-appsub
      - op: replace
        path: /spec/provisioning/installConfigSecretRef/name
        value: dev-cluster-01-install-config
      - op: replace
        path: /spec/provisioning/sshPrivateKeySecretRef/name
        value: dev-cluster-01-ssh-key
      - op: remove
        path: /spec/provisioning/manifestsConfigMapRef
      - op: replace
        path: /spec/clusterMetadata/adminKubeconfigSecretRef/name
        value: dev-cluster-01-admin-kubeconfig
      - op: replace
        path: /spec/clusterMetadata/adminPasswordSecretRef/name
        value: dev-cluster-01-admin-password

  # Update MachinePool with specific values
  - target:
      kind: MachinePool
    patch: |-
      - op: replace
        path: /metadata/name
        value: dev-cluster-01-worker
      - op: replace
        path: /metadata/namespace
        value: dev-cluster-01
      - op: replace
        path: /spec/clusterDeploymentRef/name
        value: dev-cluster-01
      - op: replace
        path: /spec/platform/aws/type
        value: m5.2xlarge
      - op: replace
        path: /spec/replicas
        value: 3

  # Update ManagedCluster
  - target:
      kind: ManagedCluster
    patch: |-
      - op: replace
        path: /metadata/name
        value: dev-cluster-01
      - op: replace
        path: /metadata/labels/environment
        value: development

  # Update KlusterletAddonConfig
  - target:
      kind: KlusterletAddonConfig
    patch: |-
      - op: replace
        path: /metadata/name
        value: dev-cluster-01
      - op: replace
        path: /metadata/namespace
        value: dev-cluster-01
      - op: replace
        path: /spec/clusterName
        value: dev-cluster-01
      - op: replace
        path: /spec/clusterNamespace
        value: dev-cluster-01

  # Update install-config Secret
  - target:
      kind: Secret
      name: cluster-placeholder-install-config
    patch: |-
      - op: replace
        path: /metadata/name
        value: dev-cluster-01-install-config
      - op: replace
        path: /metadata/namespace
        value: dev-cluster-01

# Update all placeholder references
replacements:
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.clusterName
    targets:
      - select:
          kind: ClusterDeployment
        fieldPaths:
          - spec.clusterMetadata.adminKubeconfigSecretRef.name
        options:
          delimiter: '-'
          index: 0
