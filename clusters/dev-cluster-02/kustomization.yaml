apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: dev-cluster-02

resources:
  - ../../cluster-templates/aws-ha/base
  - cluster-config.yaml

# Patches to customize the cluster
patches:
  # Update ClusterDeployment with specific values
  - target:
      kind: ClusterDeployment
    patch: |-
     - op: replace
       path: /metadata/name
       value: dev-cluster-02
     - op: replace
       path: /metadata/namespace
       value: dev-cluster-02
     - op: replace
       path: /spec/clusterName
       value: dev-cluster-02
     - op: replace
       path: /spec/baseDomain
       value: openshiftpartnerlabs.com
     - op: replace
       path: /spec/platform/aws/region
       value: us-east-1
     - op: replace
       path: /spec/provisioning/imageSetRef/name
       value: img4.20.10-x86-64-appsub
     - op: replace
       path: /spec/provisioning/installConfigSecretRef/name
       value: dev-cluster-02-install-config
     - op: replace
       path: /spec/provisioning/sshPrivateKeySecretRef/name
       value: dev-cluster-02-ssh-key
     - op: replace
       path: /spec/pullSecretRef/name
       value: dev-cluster-02-pull-secret
     - op: replace
       path: /spec/platform/aws/credentialsSecretRef/name
       value: dev-cluster-02-aws-credentials
     - op: remove
       path: /spec/provisioning/manifestsConfigMapRef

  # Update MachinePool with specific values
  - target:
      kind: MachinePool
    patch: |-
     - op: replace
       path: /metadata/name
       value: dev-cluster-02-worker
     - op: replace
       path: /metadata/namespace
       value: dev-cluster-02
     - op: replace
       path: /spec/clusterDeploymentRef/name
       value: dev-cluster-02
     - op: replace
       path: /spec/platform/aws/type
       value: m5.2xlarge
     - op: replace
       path: /spec/replicas
       value: 0

  # Update ManagedCluster
  - target:
      kind: ManagedCluster
    patch: |-
     - op: replace
       path: /metadata/name
       value: dev-cluster-02
     - op: replace
       path: /metadata/labels/environment
       value: development

  # Update KlusterletAddonConfig
  - target:
      kind: KlusterletAddonConfig
    patch: |-
     - op: replace
       path: /metadata/name
       value: dev-cluster-02
     - op: replace
       path: /metadata/namespace
       value: dev-cluster-02
     - op: replace
       path: /spec/clusterName
       value: dev-cluster-02
     - op: replace
       path: /spec/clusterNamespace
       value: dev-cluster-02

  # Update install-config Secret
  - target:
      kind: Secret
      name: cluster-placeholder-install-config
    patch: |-
     - op: replace
       path: /metadata/name
       value: dev-cluster-02-install-config
     - op: replace
       path: /metadata/namespace
       value: dev-cluster-02
     - op: replace
       path: /stringData/install-config.yaml
       value: |
         apiVersion: v1
         baseDomain: openshiftpartnerlabs.com
         metadata:
           name: dev-cluster-02

         controlPlane:
           name: master
           platform:
             aws:
               type: m5.xlarge
               rootVolume:
                 iops: 4000
                 size: 120
                 type: gp3
               zones:
                 - us-east-1a
           replicas: 1

         compute:
           - name: worker
             platform:
               aws:
                 type: m5.2xlarge
                 rootVolume:
                   iops: 2000
                   size: 100
                   type: gp3
                 zones:
                   - us-east-1a
             replicas: 0

         networking:
           clusterNetwork:
             - cidr: 10.128.0.0/14
               hostPrefix: 23
           machineNetwork:
             - cidr: 10.0.0.0/16
           serviceNetwork:
             - 172.30.0.0/16
           networkType: OVNKubernetes

         platform:
           aws:
             region: us-east-1

         fips: false
         publish: External

# Hive will automatically populate clusterMetadata fields after provisioning
